{{define "agent_response.html"}}
<div class="agent-answer">
    {{if .Error}}
        <div class="error-message">
            <h3>Error</h3>
            <p>{{.Error}}</p>
        </div>
    {{else}}
        {{if .ResponseText}}
        <div class="ai-response-text">
            <h3>AI Analysis</h3>
            <div class="markdown-content">
                <pre>{{.ResponseText}}</pre>
            </div>
        </div>
        {{end}}

        {{if .SQLQuery}}
        <div class="sql-query">
            <h3>SQL Query</h3>
            <pre class="sql-code">{{.SQLQuery}}</pre>
        </div>
        {{end}}

        {{if .TableData}}
        <div class="query-results-table">
            <h3>Query Results ({{len .TableData}} rows)</h3>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            {{range .TableColumns}}
                            <th>{{.}}</th>
                            {{end}}
                        </tr>
                    </thead>
                    <tbody>
                        {{range $row := .TableData}}
                        <tr>
                            {{range $col := $.TableColumns}}
                            <td>{{index $row $col}}</td>
                            {{end}}
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
        {{end}}

        {{if .Schools}}
        <div class="agent-results">
            <h3>Results ({{.TotalCount}} schools found)</h3>

            {{if gt .TotalCount .PageSize}}
            <div class="pagination-controls top">
                <span class="pagination-info">
                    Showing {{.StartIndex}}-{{.EndIndex}} of {{.TotalCount}} results
                </span>
                <div class="pagination-buttons">
                    {{if gt .Page 1}}
                    <button
                        hx-post="/agent/paginate"
                        hx-vals='{"query": "{{.Query}}", "page": {{.PrevPage}}, "school_ids": "{{.SchoolIDs}}"}'
                        hx-target="#agent-response"
                        hx-swap="innerHTML"
                        class="btn btn-secondary"
                    >
                        Previous
                    </button>
                    {{end}}

                    <span class="page-number">Page {{.Page}} of {{.TotalPages}}</span>

                    {{if lt .Page .TotalPages}}
                    <button
                        hx-post="/agent/paginate"
                        hx-vals='{"query": "{{.Query}}", "page": {{.NextPage}}, "school_ids": "{{.SchoolIDs}}"}'
                        hx-target="#agent-response"
                        hx-swap="innerHTML"
                        class="btn btn-secondary"
                    >
                        Next
                    </button>
                    {{end}}
                </div>
            </div>
            {{end}}

            <div class="results-list paginated">
                {{range .Schools}}
                <a href="/schools/{{.NCESSCH}}" class="school-card" target="_blank">
                    <div class="school-card-header">
                        <h4>{{.Name}}</h4>
                        <span class="school-type">{{.SchoolTypeString}}</span>
                    </div>
                    <div class="school-card-details">
                        <p class="location">{{.City}}, {{.State}}</p>
                        {{if .District}}
                        <p class="district">{{.District}}</p>
                        {{end}}
                        <div class="school-stats">
                            {{if .Enrollment.Valid}}
                            <span class="stat">
                                <strong>{{.EnrollmentString}}</strong> students
                            </span>
                            {{end}}
                            {{if .Teachers.Valid}}
                            <span class="stat">
                                <strong>{{.TeachersString}}</strong> teachers
                            </span>
                            {{end}}
                            {{if ne .StudentTeacherRatio "N/A"}}
                            <span class="stat">
                                <strong>{{.StudentTeacherRatio}}</strong> student/teacher ratio
                            </span>
                            {{end}}
                        </div>
                    </div>
                </a>
                {{end}}
            </div>

            {{if gt .TotalCount .PageSize}}
            <div class="pagination-controls bottom">
                <span class="pagination-info">
                    Showing {{.StartIndex}}-{{.EndIndex}} of {{.TotalCount}} results
                </span>
                <div class="pagination-buttons">
                    {{if gt .Page 1}}
                    <button
                        hx-post="/agent/paginate"
                        hx-vals='{"query": "{{.Query}}", "page": {{.PrevPage}}, "school_ids": "{{.SchoolIDs}}"}'
                        hx-target="#agent-response"
                        hx-swap="innerHTML"
                        class="btn btn-secondary"
                    >
                        Previous
                    </button>
                    {{end}}

                    <span class="page-number">Page {{.Page}} of {{.TotalPages}}</span>

                    {{if lt .Page .TotalPages}}
                    <button
                        hx-post="/agent/paginate"
                        hx-vals='{"query": "{{.Query}}", "page": {{.NextPage}}, "school_ids": "{{.SchoolIDs}}"}'
                        hx-target="#agent-response"
                        hx-swap="innerHTML"
                        class="btn btn-secondary"
                    >
                        Next
                    </button>
                    {{end}}
                </div>
            </div>
            {{end}}
        </div>
        {{end}}
    {{end}}
</div>
{{end}}
